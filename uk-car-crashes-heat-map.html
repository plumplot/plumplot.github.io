<!DOCTYPE html><html lang="en"><head><title>GB car crashes heat map</title><meta name="description" content="Contains Great Britain road safety data from 2009-2015."><meta name="og:title" content="GB car crashes heat map"><meta name="og:description" content="Contains Great Britain road safety data from 2009-2015."><meta name="og:type" content="website"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="author" content="Plumplot"><meta property="og:image" content="//i.plumplot.co.uk/posts/uk-car-crashes.png"><meta property="og:image:width"  content="600" /><meta property="og:image:height" content="315" /><script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script><link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"/><script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script><script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD2-MV_vw6ArVY4k281uV9UE7_xUTb4LpU&callback=initMap" async defer></script><style>.spacesm{padding-top: 15px;}.spacem{padding-top: 30px;}.space{padding-top: 60px;}.bgray{background-color: #222; padding: 10px;}a{color:#409940;text-decoration:none}a:focus,a:hover{color:#5cb85c;text-decoration:underline}a:focus{outline:5px auto -webkit-focus-ring-color;outline-offset:-2px} #map{position: absolute; width: 99%; bottom: 0; top: 0;}.legend{background-color: #222; color: #eee; border-radius: 10px; text-align: left; top: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.10); font: 15px/30px 'Helvetica Neue',Arial,Helvetica,sans-serif; padding: 0px 11px 11px 11px; position: absolute; left: 5px; z-index: 1;}.legend i{width: 30px; height: 30px; float: left; margin-right: 6px; opacity: 0.9;}
/*! * Bootstrap v3.3.7 (http://getbootstrap.com) * Copyright 2011-2016 Twitter,Inc.  * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
*//*! normalize.css v3.0.3 | MIT License | github.com/necolas/normalize.css */html{font-family:sans-serif;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}body{margin:0}small{font-size:80%}button,input,optgroup,select{margin:0;font:inherit;color:inherit}button{overflow:visible}button,select{text-transform:none}button{-webkit-appearance:button;cursor:pointer}button::-moz-focus-inner,input::-moz-focus-inner{padding:0;border:0}input{line-height:normal}optgroup{font-weight:700}/*! Source: https://github.com/h5bp/html5-boilerplate/blob/master/src/css/main.css */*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}:after,:before{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}html{font-size:10px;-webkit-tap-highlight-color:rgba(0,0,0,0)}body{font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;font-size:14px;line-height:1.42857143;color:#333;background-color:#fff}button,input,select{font-family:inherit;font-size:inherit;line-height:inherit}h3,h4{font-family:inherit;font-weight:500;line-height:1.1;color:inherit}h4 small{font-weight:400;line-height:1;color:#777}h3{margin-top:20px;margin-bottom:10px}h4{margin-top:10px;margin-bottom:10px}h4 small{font-size:75%}h3{font-size:24px}h4{font-size:18px}small{font-size:85%}.form-control{display:block;width:100%;height:34px;padding:6px 12px;font-size:14px;line-height:1.42857143;color:#555;background-color:#fff;background-image:none;border:1px solid #ccc;border-radius:4px;-webkit-box-shadow:inset 0 1px 1px rgba(0,0,0,.075);box-shadow:inset 0 1px 1px rgba(0,0,0,.075);-webkit-transition:border-color ease-in-out .15s,-webkit-box-shadow ease-in-out .15s;-o-transition:border-color ease-in-out .15s,box-shadow ease-in-out .15s;transition:border-color ease-in-out .15s,box-shadow ease-in-out .15s}.form-control:focus{border-color:#66afe9;outline:0;-webkit-box-shadow:inset 0 1px 1px rgba(0,0,0,.075),0 0 8px rgba(102,175,233,.6);box-shadow:inset 0 1px 1px rgba(0,0,0,.075),0 0 8px rgba(102,175,233,.6)}.form-control::-moz-placeholder{color:#999;opacity:1}.form-control:-ms-input-placeholder{color:#999}.form-control::-webkit-input-placeholder{color:#999}.form-control::-ms-expand{background-color:transparent;border:0}.btn{display:inline-block;padding:6px 12px;margin-bottom:0;font-size:14px;font-weight:400;line-height:1.42857143;text-align:center;white-space:nowrap;vertical-align:middle;-ms-touch-action:manipulation;touch-action:manipulation;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;background-image:none;border:1px solid transparent;border-radius:4px}.btn:active:focus,.btn:focus{outline:5px auto -webkit-focus-ring-color;outline-offset:-2px}.btn:focus,.btn:hover{color:#333;text-decoration:none}.btn:active{background-image:none;outline:0;-webkit-box-shadow:inset 0 3px 5px rgba(0,0,0,.125);box-shadow:inset 0 3px 5px rgba(0,0,0,.125)}.btn-success{color:#fff;background-color:#5cb85c;border-color:#4cae4c}.btn-success:focus{color:#fff;background-color:#449d44;border-color:#255625}.btn-success:hover{color:#fff;background-color:#449d44;border-color:#398439}.btn-success:active{color:#fff;background-color:#449d44;border-color:#398439}.btn-success:active:focus,.btn-success:active:hover{color:#fff;background-color:#398439;border-color:#255625}.btn-success:active{background-image:none}@-ms-viewport{width:device-width}
/*# sourceMappingURL=bootstrap.min.css.map */</style>
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-86254916-1','auto');ga('send','pageview');
L.Google=L.Layer.extend({includes: L.Mixin.Events,
options:{
minZoom:0,
maxZoom:18,
tileSize:256,
subdomains:'abc',
errorTileUrl:'',
attribution:'',
opacity:1,
continuousWorld:false,
noWrap:false,
mapOptions:{
backgroundColor:'#dddddd'
}
},
initialize:function(type,options){
L.Util.setOptions(this,options);
this._ready=google.maps.Map !== undefined;
if (!this._ready) L.Google.asyncWait.push(this);
this._type=type || 'SATELLITE';
},
onAdd:function(map,insertAtTheBottom){
this._map=map;
this._insertAtTheBottom=insertAtTheBottom;
this._initContainer();
this._initMapObject();
map.on('viewreset',this._reset,this);
this._limitedUpdate=L.Util.throttle(this._update,150,this);
map.on('move',this._update,this);
map.on('zoomanim',this._handleZoomAnim,this);
map._controlCorners.bottomright.style.marginBottom='20px';
this._reset();
this._update();
},
onRemove:function(map){
map._container.removeChild(this._container);
map.off('viewreset',this._reset,this);
map.off('move',this._update,this);
map.off('zoomanim',this._handleZoomAnim,this);
map._controlCorners.bottomright.style.marginBottom='0em';
},
getAttribution:function(){
return this.options.attribution;
},
setOpacity:function(opacity){
this.options.opacity=opacity;
if (opacity < 1){
L.DomUtil.setOpacity(this._container,opacity);
}
},
setElementSize:function(e,size){
e.style.width=size.x + 'px';
e.style.height=size.y + 'px';
},
_initContainer:function(){
var tilePane=this._map._container,
first=tilePane.firstChild;
if (!this._container){
this._container=L.DomUtil.create('div','leaflet-google-layer');
this._container.id='_GMapContainer_' + L.Util.stamp(this);
this._container.style.zIndex='auto';
}
tilePane.insertBefore(this._container,first);
this.setOpacity(this.options.opacity);
this.setElementSize(this._container,this._map.getSize());
},
_initMapObject:function(){
if (!this._ready) return;
this._google_center=new google.maps.LatLng(0,0);
var map=new google.maps.Map(this._container,{
center: this._google_center,
zoom: 0,
tilt: 0,
mapTypeId: google.maps.MapTypeId[this._type],
disableDefaultUI: true,
keyboardShortcuts: false,
draggable: false,
disableDoubleClickZoom: true,
scrollwheel: false,
streetViewControl: false,
styles: this.options.mapOptions.styles,
backgroundColor: this.options.mapOptions.backgroundColor
});
var _this=this;
this._reposition=google.maps.event.addListenerOnce(map,'center_changed',
function(){_this.onReposition();});
this._google=map;
google.maps.event.addListenerOnce(map,'idle',
function(){_this._checkZoomLevels();});
google.maps.event.addListenerOnce(map,'tilesloaded',
function(){_this.fire('load');});
this.fire('MapObjectInitialized',{mapObject: map});
},
_checkZoomLevels:function(){
if ((this._map.getZoom() !== undefined) && (this._google.getZoom() !== Math.round(this._map.getZoom()))){
this._map.setZoom(this._google.getZoom());
}
},
_reset:function(){
this._initContainer();
},
_update:function(){
if (!this._google) return;
this._resize();
var center=this._map.getCenter();
var _center=new google.maps.LatLng(center.lat,center.lng);
this._google.setCenter(_center);
if (this._map.getZoom() !== undefined)
this._google.setZoom(Math.round(this._map.getZoom()));
this._checkZoomLevels();
},
_resize:function(){
var size=this._map.getSize();
if (this._container.style.width === size.x &&
this._container.style.height === size.y)
return;
this.setElementSize(this._container,size);
this.onReposition();
},
_handleZoomAnim:function(e){
var center=e.center;
var _center=new google.maps.LatLng(center.lat,center.lng);
this._google.setCenter(_center);
this._google.setZoom(Math.round(e.zoom));
},
onReposition:function(){
if (!this._google) return;
google.maps.event.trigger(this._google,'resize');
}
});
L.Google.asyncWait=[];
L.Google.asyncInitialize=function(){
var i;
for (i=0; i < L.Google.asyncWait.length; i++){
var o=L.Google.asyncWait[i];
o._ready=true;
if (o._container){
o._initMapObject();
o._update();
}
}
L.Google.asyncWait=[];
};
/* (c) 2014,Vladimir Agafonkin,simpleheat,a tiny JavaScript library for drawing heatmaps with Canvas,https://github.com/mourner/simpleheat */
!function(){"use strict";function t(i){return this instanceof t?(this._canvas=i="string"==typeof i?document.getElementById(i):i,this._ctx=i.getContext("2d"),this._width=i.width,this._height=i.height,this._max=1,void this.clear()):new t(i)}t.prototype={defaultRadius:25,defaultGradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"},data:function(t,i){return this._data=t,this},max:function(t){return this._max=t,this},add:function(t){return this._data.push(t),this},clear:function(){return this._data=[],this},radius:function(t,i){i=i||15;var a=this._circle=document.createElement("canvas"),s=a.getContext("2d"),e=this._r=t+i;return a.width=a.height=2*e,s.shadowOffsetX=s.shadowOffsetY=200,s.shadowBlur=i,s.shadowColor="black",s.beginPath(),s.arc(e-200,e-200,t,0,2*Math.PI,!0),s.closePath(),s.fill(),this},gradient:function(t){var i=document.createElement("canvas"),a=i.getContext("2d"),s=a.createLinearGradient(0,0,0,256);i.width=1,i.height=256;for(var e in t)s.addColorStop(e,t[e]);return a.fillStyle=s,a.fillRect(0,0,1,256),this._grad=a.getImageData(0,0,1,256).data,this},draw:function(t){this._circle||this.radius(this.defaultRadius),this._grad||this.gradient(this.defaultGradient);var i=this._ctx;i.clearRect(0,0,this._width,this._height);for(var a,s=0,e=this._data.length;e>s;s++)a=this._data[s],i.globalAlpha=Math.max(a[2]/this._max,t||.05),i.drawImage(this._circle,a[0]-this._r,a[1]-this._r);var n=i.getImageData(0,0,this._width,this._height);return this._colorize(n.data,this._grad),i.putImageData(n,0,0),this},_colorize:function(t,i){for(var a,s=3,e=t.length;e>s;s+=4)a=4*t[s],a&&(t[s-3]=i[a],t[s-2]=i[a+1],t[s-1]=i[a+2])}},window.simpleheat=t}(),/*
(c) 2014,Vladimir Agafonkin Leaflet.heat,a tiny and fast heatmap plugin for Leaflet. https://github.com/Leaflet/Leaflet.heat */
L.HeatLayer=(L.Layer?L.Layer:L.Class).extend({initialize:function(t,i){this._latlngs=t,L.setOptions(this,i)},setLatLngs:function(t){return this._latlngs=t,this.redraw()},addLatLng:function(t){return this._latlngs.push(t),this.redraw()},setOptions:function(t){return L.setOptions(this,t),this._heat&&this._updateOptions(),this.redraw()},redraw:function(){return!this._heat||this._frame||this._map._animating||(this._frame=L.Util.requestAnimFrame(this._redraw,this)),this},onAdd:function(t){this._map=t,this._canvas||this._initCanvas(),t._panes.overlayPane.appendChild(this._canvas),t.on("moveend",this._reset,this),t.options.zoomAnimation&&L.Browser.any3d&&t.on("zoomanim",this._animateZoom,this),this._reset()},onRemove:function(t){t.getPanes().overlayPane.removeChild(this._canvas),t.off("moveend",this._reset,this),t.options.zoomAnimation&&t.off("zoomanim",this._animateZoom,this)},addTo:function(t){return t.addLayer(this),this},_initCanvas:function(){var t=this._canvas=L.DomUtil.create("canvas","leaflet-heatmap-layer leaflet-layer"),i=L.DomUtil.testProp(["transformOrigin","WebkitTransformOrigin","msTransformOrigin"]);t.style[i]="50% 50%";var a=this._map.getSize();t.width=a.x,t.height=a.y;var s=this._map.options.zoomAnimation&&L.Browser.any3d;L.DomUtil.addClass(t,"leaflet-zoom-"+(s?"animated":"hide")),this._heat=simpleheat(t),this._updateOptions()},_updateOptions:function(){this._heat.radius(this.options.radius||this._heat.defaultRadius,this.options.blur),this.options.gradient&&this._heat.gradient(this.options.gradient),this.options.max&&this._heat.max(this.options.max)},_reset:function(){var t=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(this._canvas,t);var i=this._map.getSize();this._heat._width!==i.x&&(this._canvas.width=this._heat._width=i.x),this._heat._height!==i.y&&(this._canvas.height=this._heat._height=i.y),this._redraw()},_redraw:function(){var t,i,a,s,e,n,h,o,r,d=[],_=this._heat._r,l=this._map.getSize(),m=new L.Bounds(L.point([-_,-_]),l.add([_,_])),c=void 0===this.options.max?1:this.options.max,u=void 0===this.options.maxZoom?this._map.getMaxZoom():this.options.maxZoom,f=1/Math.pow(2,Math.max(0,Math.min(u-this._map.getZoom(),12))),g=_/2,p=[],v=this._map._getMapPanePos(),w=v.x%g,y=v.y%g;for(t=0,i=this._latlngs.length;i>t;t++)if(a=this._map.latLngToContainerPoint(this._latlngs[t]),m.contains(a)){e=Math.floor((a.x-w)/g)+2,n=Math.floor((a.y-y)/g)+2;var x=void 0!==this._latlngs[t].alt?this._latlngs[t].alt:void 0!==this._latlngs[t][2]?+this._latlngs[t][2]:1;r=x*f,p[n]=p[n]||[],s=p[n][e],s?(s[0]=(s[0]*s[2]+a.x*r)/(s[2]+r),s[1]=(s[1]*s[2]+a.y*r)/(s[2]+r),s[2]+=r):p[n][e]=[a.x,a.y,r]}for(t=0,i=p.length;i>t;t++)if(p[t])for(h=0,o=p[t].length;o>h;h++)s=p[t][h],s&&d.push([Math.round(s[0]),Math.round(s[1]),Math.min(s[2],c)]);this._heat.data(d).draw(this.options.minOpacity),this._frame=null},_animateZoom:function(t){var i=this._map.getZoomScale(t.zoom),a=this._map._getCenterOffset(t.center)._multiplyBy(-i).subtract(this._map._getMapPanePos());L.DomUtil.setTransform?L.DomUtil.setTransform(this._canvas,a,i):this._canvas.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(a)+" scale("+i+")"}}),L.heatLayer=function(t,i){return new L.HeatLayer(t,i)};
var S ={'map_marker' : undefined};
function addGoogle(map){
var sat=new L.Google('SATELLITE');
var roads=new L.Google('ROADMAP');
map.addLayer(roads);
map.addLayer(sat);
map.addControl(new L.Control.Layers({
'Roads ':roads,
'Aerial':sat
},
undefined,
{position: 'topright',collapsed: false})
);
}
function set_marker(lat,lon,label){
var marker=L.marker([lat,lon]);
S['map'].addLayer(marker);
marker.bindPopup(label).openPopup();
S['map_marker']=marker;
S['map'].setView([lat,lon]);
}
function set_marker_async(postcode){
$.ajax({
url: 'https://api.postcodes.io/postcodes/' + postcode.replace(/ /g,''),
data:{},
format: 'json',
error:function(jqXHR,textStatus,errorThrown){
if ( jqXHR.status == 404 ){
alert("Postcode not found")
} else{
alert('Postcode error. Please check your postcode or try again later');
}
},
dataType: 'jsonp',
success:function(data){
if ( data['status'] == 200 ){
set_marker(
data['result']['latitude'],
data['result']['longitude'],
postcode + '<br>' + data['result']['nuts'] + '<br>' + data['result']['admin_ward']
);
} else{
alert('Postcode error. Please check your postcode or try again later');
}
},
type: 'GET'
});
}
function getData(url){
var resp=$.ajax({
url: url,
dataType: "json",
async: false
});
if ( resp.status === 404 ){
alert('No data for postcode');
return [];
} else{
return resp.responseJSON;
}
}
function dump(obj){
prompt('Dump',JSON.stringify(obj));
}
function onPostcode(pcd){
if ( pcd.indexOf(' ') > 0 ){
var postcode=pcd.substr(0,12).toUpperCase();
var district=postcode.replace(/ .*/,'');
if ( S['map_marker'] !== undefined ){
S['map'].removeLayer(S['map_marker']);
}
if ( postcode === 'EC4R 0HH' ){
set_marker(
51.5103895836506,
-0.0890662382804032,
'EC4R 0HH<br>Camden and City of London<br>Dowgate'
);
} else{
set_marker_async(postcode);
}
var data=getData('/a/crashes/' + district + '.json');
if ( S['heat'] !== undefined ){
S['map'].removeLayer(S['heat']);
}
S['heat']=L.heatLayer(
data.map(function(p){return [p[0],p[1]];}),
{minOpacity : 0.5}
);
S['map'].addLayer(S['heat']);
var legend=L.control({position: 'topleft'});
legend.onAdd=function(map){
this._div=L.DomUtil.get('leg')
return this._div;
};
legend.addTo(S['map']);
} else{
alert("Postcode must contain a space e.g. 'EC4R 0HH'.");
}
}
function initMap(){
window.onload=function(){var map=L.map("map",{center: [51.55,-0.04],zoom :17,minZoom: 15,attributionControl:false,zoomControl: false});L.control.attribution({prefix: '<span class="AttributionClass"><a href="http://leafletjs.com">Leaflet</a> | Data:<a href="https://data.gov.uk/dataset/road-accidents-safety-data">source</a>,<a href="http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3">OGL v3.0.</a></span>',position: 'topright'}).addTo(map);addGoogle(map);L.control.zoom({position:'topright'}).addTo(map);S['map']=map; onPostcode('EC4R 0HH');};
}
</script></head>
<body style="background-color: black; color: #ccc;"><div id="map"></div><div id="leg" class="legend" style="text-align:center;"><a href="/"><h3 style="text-align: left;">&nbsp;<span style="color: #7CB342;">&#x25C9;&nbsp;plumplot</span>&nbsp;</h3></a><h4>GB car crashes<br><small>2009-2015</small></h4><input type="text" class="form-control" id="pcd_opt" placeholder="e.g. EC4R 0HH" onchange="onPostcode(this.value)" onfocus="this.value=''" size="12" maxlength="8"/><button class="btn btn-success">Find postcode</button></div></body></html>
